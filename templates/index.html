<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheepCoin Cloud Mining</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script> <style>
        /* (Gunakan CSS yang sama seperti sebelumnya, saya persingkat untuk fokus logika) */
        body { background: #0f172a; color: white; font-family: 'Space Grotesk'; padding: 20px; text-align: center; }
        button { padding: 10px 20px; font-weight: bold; cursor: pointer; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; margin: 10px auto; max-width: 600px; border-radius: 10px; }
        input { padding: 10px; width: 80%; margin: 5px; }
    </style>
</head>
<body>

    <h1>ğŸ‘ SheepCoin Cloud</h1>
    <div id="loginArea">
        <button onclick="connectWallet()">ğŸ¦Š Connect MetaMask</button>
    </div>

    <div id="dashboard" style="display:none;">
        <p>Wallet: <span id="myAddress" style="color:#00d4ff">...</span></p>
        <h2>Saldo: <span id="balance">0</span> SHP</h2>
        
        <div class="card">
            <h3>â›ï¸ Local Browser Mining</h3>
            <p>Mining dilakukan oleh device Anda, diverifikasi oleh Server.</p>
            <div id="statusLog" style="color: yellow; margin-bottom: 10px;">Idle</div>
            <button id="btnMine" onclick="startMining()">Start Mining (PoW)</button>
        </div>

        <div class="card">
            <h3>ğŸ’¸ Kirim Koin</h3>
            <input id="recipient" placeholder="Address Penerima (0x...)">
            <input id="amount" placeholder="Jumlah" type="number">
            <button onclick="sendCoin()">Kirim</button>
        </div>

        <div class="card">
            <h3>ğŸ”— Blockchain (Realtime)</h3>
            <div id="chainList" style="text-align:left; font-size:0.8rem;"></div>
        </div>
    </div>

<script>
    let userAddress = null;

    async function connectWallet() {
        if (window.ethereum) {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            userAddress = accounts[0];
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('myAddress').innerText = userAddress;
            updateData();
        } else { alert("Install MetaMask!"); }
    }

    async function updateData() {
        if(!userAddress) return;
        
        // Ambil Saldo
        let res = await fetch('/wallet_info', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ address: userAddress })
        });
        let data = await res.json();
        document.getElementById('balance').innerText = data.balance.toFixed(4);

        // Ambil Chain
        let chainRes = await fetch('/chain');
        let chainData = await chainRes.json();
        let html = '';
        chainData.chain.forEach(b => {
            html += `<div style="border-bottom:1px solid #333; padding:5px;">
                <b>Block #${b.index}</b> | Miner: ${b.miner.substring(0,6)}...<br>
                Proof: ${b.proof}
            </div>`;
        });
        document.getElementById('chainList').innerHTML = html;
    }

    // --- LOGIKA MINING LOKAL (CLIENT SIDE) ---
    async function startMining() {
        const btn = document.getElementById('btnMine');
        const log = document.getElementById('statusLog');
        btn.disabled = true;
        log.innerText = "1. Mengambil data blok terakhir dari server...";

        try {
            // 1. Minta Pekerjaan (Last Proof) dari Server
            const jobRes = await fetch('/get_mining_job');
            const job = await jobRes.json();
            
            const lastProof = job.last_proof;
            const difficulty = job.difficulty;
            const target = "0".repeat(difficulty);
            
            log.innerText = `2. Menambang... (Mencari hash diawali ${target})`;

            // 2. Lakukan Hashing di Browser (CPU User bekerja di sini)
            // Ini mencegah server crash.
            let proof = 0;
            let found = false;
            
            // Loop Mining (Jeda setiap 1000 iterasi agar browser tidak hang)
            const miningLoop = async () => {
                for(let i=0; i<5000; i++) {
                    // Algoritma PoW sederhana: sha256(last_proof + proof)
                    const guess = `${lastProof}${proof}`;
                    const hash = sha256(guess); // Menggunakan library js-sha256
                    
                    if(hash.startsWith(target)) {
                        found = true;
                        submitProof(proof);
                        return;
                    }
                    proof++;
                }
                if(!found) {
                    log.innerText = `Mining... Mencoba Proof: ${proof}`;
                    setTimeout(miningLoop, 0); // Lanjut loop tanpa freeze UI
                }
            };
            
            miningLoop();

        } catch(e) {
            console.error(e);
            log.innerText = "Error koneksi server";
            btn.disabled = false;
        }
    }

    async function submitProof(proof) {
        const log = document.getElementById('statusLog');
        log.innerText = `3. Hash Ditemukan! Mengirim Proof: ${proof} ke server...`;
        
        try {
            const res = await fetch('/submit_block', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ proof: proof, miner: userAddress })
            });
            const data = await res.json();
            
            if(data.success) {
                log.innerText = `âœ… SUKSES! Reward +${data.reward} SHP diterima.`;
                updateData();
            } else {
                log.innerText = `âŒ Ditolak Server: ${data.message}`;
            }
        } catch(e) { log.innerText = "Gagal kirim proof"; }
        
        document.getElementById('btnMine').disabled = false;
    }

    async function sendCoin() {
        const recipient = document.getElementById('recipient').value;
        const amount = document.getElementById('amount').value;
        
        await fetch('/transact', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ sender: userAddress, recipient: recipient, amount: amount })
        });
        alert("Transaksi dikirim!");
        updateData();
    }
    
    // Auto refresh data setiap 10 detik
    setInterval(updateData, 10000);
</script>
</body>
</html>