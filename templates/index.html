<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheepCoin Cloud Mining</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <style>
        :root {
            --primary-color: #8A2BE2;
            --secondary-color: #00d4ff;
            --accent-color: #f6851b;
            --success-color: #2ed573;
            --danger-color: #ff4757;
            --bg-dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1.main-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container { width: 100%; max-width: 600px; margin: auto; }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        input {
            width: 100%; padding: 15px; margin: 10px 0;
            background: rgba(0, 0, 0, 0.2); border: none; border-radius: 12px;
            color: white; font-size: 1rem; box-sizing: border-box;
        }

        button {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.3s;
        }
        button:hover { transform: translateY(-3px); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .btn-connect { background: linear-gradient(45deg, var(--accent-color), #e2761b); color: white; }
        .btn-mine { background: linear-gradient(45deg, var(--primary-color), #6a0dad); color: white; margin-top: 15px; }
        .btn-send { background: linear-gradient(45deg, var(--secondary-color), #00a8cc); color: #0f172a; margin-top: 15px; }
        .btn-stop { background: linear-gradient(45deg, var(--danger-color), #c0392b); color: white; margin-top: 15px; }

        .grid-packages { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .pkg-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: var(--secondary-color); padding: 15px 10px; font-size: 0.9rem; border-radius: 16px;
        }
        .pkg-btn:hover { background: var(--primary-color); color: white; }

        #activeRentalPanel {
            background: rgba(46, 213, 115, 0.15); border: 1px solid var(--success-color);
            padding: 15px; border-radius: 12px; margin-top: 15px;
        }

        .tx-item, .block-item {
            background: rgba(255, 255, 255, 0.03); padding: 15px; margin-bottom: 10px;
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
        }

        .block-item { border-left: 4px solid var(--secondary-color); text-align: left; }
        .block-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .hash-text { font-family: monospace; font-size: 0.75rem; color: #aaa; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; word-break: break-all; }

        .tx-in { color: var(--success-color); font-weight: bold; }
        .tx-out { color: var(--danger-color); font-weight: bold; }
        .tx-mine { color: #ffd700; font-weight: bold; }
        #timerDisplay { font-size: 1.5rem; font-weight: 800; color: var(--success-color); margin: 15px 0; }
        #balance { font-weight: 800; background: linear-gradient(to right, #fff, var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>

    <h1 class="main-title">üêë SheepCoin Cloud</h1>
    
    <div class="container">
        <div id="loginArea" style="min-height: 60vh; display:flex; flex-direction:column; justify-content:center;">
            <div class="card" style="text-align: center;">
                <h2>Selamat Datang</h2>
                <p>Hubungkan MetaMask Anda untuk mengakses Dashboard.</p>
                <button class="btn-connect" onclick="connectWallet()">ü¶ä Connect MetaMask</button>
            </div>
        </div>

        <div id="dashboard" style="display:none;">
            <div style="text-align: center; margin-bottom: 30px;">
                <p style="margin-bottom: 5px; color:#aaa;">Dompet Terhubung:</p>
                <div id="myAddress" style="color:var(--secondary-color); font-family:monospace; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 20px; display: inline-block;">...</div>
                <h2 style="font-size:3.5rem; margin:10px 0;"><span id="balance">0.0000</span> SHP</h2>
            </div>
            
            <div class="card">
                <h3>ü§ñ Auto Mining Rental</h3>
                <p>Sewa bot cloud untuk melakukan mining otomatis.</p>
                
                <div id="rentalPanel">
                    <div class="grid-packages">
                        <button class="pkg-btn" onclick="buyPackage(10)"><strong>10 Menit</strong><br>(5 SHP)</button>
                        <button class="pkg-btn" onclick="buyPackage(30)"><strong>30 Menit</strong><br>(10 SHP)</button>
                        <button class="pkg-btn" onclick="buyPackage(60)"><strong>1 Jam</strong><br>(18 SHP)</button>
                    </div>
                </div>

                <div id="activeRentalPanel" style="display:none;">
                    <span style="font-weight: 700; font-size: 1.1rem;">‚ö° Auto Mining Aktif!</span>
                    <div id="timerDisplay">00:00:00</div>
                    <p style="font-size:0.9rem; margin:0;">(Bot bekerja, jangan tutup tab ini)</p>
                </div>
                
                <div id="statusLog" style="color: #ffd700; margin-top: 20px; font-weight: 500; min-height:25px; text-align: center;">Idle</div>
                
                <button class="btn-mine" id="btnMine" onclick="startMining(false)">‚õèÔ∏è Manual Mining (Sekali)</button>
                <button class="btn-stop" id="btnStop" onclick="stopAutoMine()" style="display: none;">üõë STOP Auto Mining</button>
            </div>

            <div class="card">
                <h3>üí∏ Kirim Koin</h3>
                <input id="recipient" placeholder="Alamat Penerima (0x...)" autocomplete="off">
                <input id="amount" placeholder="Jumlah SHP" type="number" step="0.0001">
                <button class="btn-send" id="btnSend" onclick="sendCoin()">üöÄ Kirim (Sign MetaMask)</button>
            </div>

            <div class="card">
                <h3>üìú Riwayat Dompet</h3>
                <div id="myHistory" style="max-height: 300px; overflow-y: auto; margin-top: 20px;">
                    <p style="text-align:center;">Memuat data...</p>
                </div>
            </div>

            <div class="card">
                <h3>üîó Global Blockchain Ledger</h3>
                <p style="margin-bottom: 20px;">10 blok terakhir di jaringan.</p>
                <div id="chainList"></div>
            </div>
        </div>
    </div>

<script>
    let userAddress = null;
    let autoMineExpiry = 0;
    
    // VARIABEL KONTROL STOP
    let isAutoLoopRunning = false;
    let currentSessionId = 0; // ID unik untuk setiap sesi mining

    async function connectWallet() {
        if (window.ethereum) {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                document.getElementById('loginArea').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('myAddress').innerText = userAddress.substring(0,8) + "..." + userAddress.substring(36);
                updateData();
            } catch (err) {}
        } else { alert("Install MetaMask!"); }
    }

    async function updateData() {
        if(!userAddress) return;
        
        try {
            let res = await fetch('/wallet_info', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress })
            });
            let data = await res.json();
            document.getElementById('balance').innerText = data.balance.toFixed(4);
            
            const now = data.server_time;
            autoMineExpiry = data.auto_mine_expires;
            const rentalPanel = document.getElementById('rentalPanel');
            const activePanel = document.getElementById('activeRentalPanel');
            const btnStop = document.getElementById('btnStop');
            const timerDisplay = document.getElementById('timerDisplay');

            if (autoMineExpiry > now) {
                rentalPanel.style.display = 'none';
                activePanel.style.display = 'block';
                btnStop.style.display = 'block';
                const timeLeft = Math.floor(autoMineExpiry - now);
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                timerDisplay.innerText = `${m}m ${s}s`;
                
                // Mulai Auto Mine hanya jika belum jalan
                if (!isAutoLoopRunning) { 
                    isAutoLoopRunning = true; 
                    currentSessionId++; // Buat sesi baru
                    autoMineLoop(currentSessionId); // Jalankan dengan ID sesi
                }
            } else {
                rentalPanel.style.display = 'block';
                activePanel.style.display = 'none';
                btnStop.style.display = 'none';
                isAutoLoopRunning = false;
            }

        } catch(e) {}
        
        loadHistory();
        loadChain();
    }
    
    function formatTime(timestamp) {
        return new Date(timestamp * 1000).toLocaleString('id-ID', {
            day: 'numeric', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }

    async function loadHistory() {
         try {
            let histRes = await fetch('/my_transactions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress })
            });
            let histData = await histRes.json();
            let histHtml = '';
            
            if(histData.transactions.length === 0){
                histHtml = '<p style="text-align:center; opacity:0.7;">Belum ada transaksi.</p>';
            } else {
                histData.transactions.forEach(tx => {
                    let color = tx.type === 'MINING' ? 'tx-mine' : (tx.type === 'IN' ? 'tx-in' : 'tx-out');
                    let sign = tx.type === 'OUT' ? '-' : '+';
                    let icon = tx.type === 'MINING' ? 'üéÅ' : (tx.type === 'IN' ? '‚¨áÔ∏è From:' : '‚¨ÜÔ∏è To:');
                    let addr = tx.type === 'IN' ? tx.sender : tx.recipient;
                    if(tx.type !== 'MINING') addr = addr.substring(0,6)+'...'; else addr = 'Reward';

                    let timeStr = tx.timestamp ? formatTime(tx.timestamp) : '-';

                    histHtml += `<div class="tx-item">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:1.2rem">${icon}</span>
                            <div>
                                <div style="font-weight:bold;">${tx.type}</div>
                                <div style="font-size:0.75rem; opacity:0.8;">${addr} | ${timeStr}</div>
                            </div>
                        </div>
                        <span class="${color}" style="font-size:1.1rem;">${sign}${parseFloat(tx.amount).toFixed(4)}</span>
                    </div>`;
                });
            }
            document.getElementById('myHistory').innerHTML = histHtml;
        } catch(e) {}
    }

    async function loadChain() {
        try {
            let chainRes = await fetch('/chain');
            let chainData = await chainRes.json();
            let html = '';
            
            chainData.chain.forEach(b => {
                let localTime = formatTime(b.timestamp);
                html += `
                <div class="block-item">
                    <div class="block-header">
                        <strong style="color:var(--secondary-color);">Block #${b.index}</strong>
                        <span style="font-size:0.75rem; opacity:0.7;">${localTime}</span>
                    </div>
                    <div class="hash-text">${b.hash}</div>
                    <div style="font-size:0.8rem; margin-top:8px; display:flex; justify-content:space-between;">
                        <span>Miner: <span style="color:var(--accent-color);">${b.miner.substring(0,8)}...</span></span>
                        <span>Proof: <strong>${b.proof}</strong></span>
                    </div>
                </div>
                `;
            });
            document.getElementById('chainList').innerHTML = html;
        } catch(e) {}
    }

    async function buyPackage(minutes) {
        if(!confirm(`Konfirmasi: Sewa Auto Mining selama ${minutes} menit?`)) return;
        try {
            const res = await fetch('/buy_auto_mine', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress, minutes: minutes })
            });
            const data = await res.json();
            if(data.success) { alert(data.message); updateData(); } 
            else { alert("Gagal: " + data.message); }
        } catch(e) { alert("Error Server"); }
    }

    // --- LOGIKA STOP (DIPERBAIKI DENGAN SESSION ID) ---
    function stopAutoMine() {
        if(confirm("Yakin hentikan Auto Mining?")) {
            // 1. Matikan Flag Global
            isAutoLoopRunning = false; 
            // 2. Ganti Session ID (Ini akan membatalkan loop yang sedang berjalan)
            currentSessionId++; 
            
            document.getElementById('statusLog').innerText = "üõë Berhenti...";
            document.getElementById('btnStop').style.display = 'none';
            setTimeout(updateData, 500); 
        }
    }

    async function autoMineLoop(sessionId) {
        // Loop ini hanya akan jalan jika sessionId-nya VALID (sesuai yang aktif sekarang)
        while(isAutoLoopRunning && sessionId === currentSessionId) {
            document.getElementById('statusLog').innerHTML = "ü§ñ Bot: <span style='color:white;'>Mencari hash...</span>";
            
            await startMining(true, sessionId);
            
            // Cek Session ID lagi setelah mining selesai
            if (sessionId !== currentSessionId) break; 
            
            await new Promise(r => setTimeout(r, 2000));
            
            if(Date.now()/1000 > autoMineExpiry) { 
                isAutoLoopRunning = false; 
                updateData(); 
            }
        }
    }

    async function startMining(isAuto, sessionId = null) {
        const btn = document.getElementById('btnMine');
        const log = document.getElementById('statusLog');
        if(!isAuto) btn.disabled = true;
        if(!isAuto) log.innerText = "Menghubungkan...";

        try {
            const jobRes = await fetch('/get_mining_job');
            const job = await jobRes.json();
            const target = "0".repeat(job.difficulty);
            
            // CEK 1: Jika distop saat fetch
            if(isAuto && sessionId !== currentSessionId) return;

            let proof = 0;
            let found = false;
            const lastProof = job.last_proof;

            await new Promise(resolve => {
                const miningStep = () => {
                    // CEK 2: Jika distop saat looping hash (Critical Check)
                    if(isAuto && sessionId !== currentSessionId) {
                        resolve(); // Keluar paksa
                        return;
                    }

                    // Loop hashing diperkecil agar UI lebih responsif terhadap klik Stop
                    for(let i=0; i<1000; i++) { 
                        const guess = `${lastProof}${proof}`;
                        const hash = sha256(guess); 
                        if(hash.startsWith(target)) { found = true; break; }
                        proof++;
                    }

                    if(found) resolve(); 
                    else if(!isAutoLoopRunning && isAuto) resolve(); 
                    else if(proof > 10000000) { resolve(); } 
                    else setTimeout(miningStep, 0);
                };
                miningStep();
            });

            // Submit hanya jika ketemu & Sesi masih valid
            if(found) {
                if(isAuto && sessionId !== currentSessionId) return; // Jangan submit jika sudah stop

                if(!isAuto) log.innerText = "Hash ditemukan! Mengirim...";
                const res = await fetch('/submit_block', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ proof: proof, miner: userAddress })
                });
                const data = await res.json();
                if(data.success) {
                    const msg = `‚úÖ Block #${data.index} Ditemukan! Reward: ${data.reward} SHP`;
                    log.innerText = msg;
                    if(!isAuto) alert(msg);
                }
            }
        } catch(e) { console.error(e); }
        
        if(!isAuto) { btn.disabled = false; updateData(); }
    }

    async function sendCoin() {
        const recipient = document.getElementById('recipient').value;
        const amount = document.getElementById('amount').value;
        const btn = document.getElementById('btnSend');
        if(!recipient || !amount) { alert("Data tidak lengkap."); return; }

        try {
            btn.innerText = "Sign MetaMask...";
            btn.disabled = true;
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            await signer.signMessage(`Konfirmasi: Kirim ${amount} SHP ke ${recipient}`);
            
            btn.innerText = "Mengirim...";
            await fetch('/transact', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sender: userAddress, recipient: recipient, amount: amount })
            });
            alert("Berhasil Dikirim!");
            document.getElementById('recipient').value = '';
            document.getElementById('amount').value = '';
            updateData();
        } catch(e) { alert("Batal."); }
        btn.innerText = "üöÄ Kirim (Sign MetaMask)";
        btn.disabled = false;
    }
    
    setInterval(updateData, 5000);
</script>
</body>
</html>