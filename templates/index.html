<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheepCoin Cloud Mining</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <style>
        body { background: #0f172a; color: white; font-family: 'Space Grotesk'; padding: 20px; text-align: center; }
        button { padding: 12px 20px; font-weight: bold; cursor: pointer; border:none; border-radius:8px; transition:0.3s; }
        button:hover { transform: translateY(-2px); opacity:0.9; }
        .btn-connect { background: #f6851b; color: white; font-size: 1.1rem; }
        .btn-mine { background: #8A2BE2; color: white; width:100%; margin-top:10px; }
        .btn-send { background: #00d4ff; color: #000; width:100%; margin-top:10px; }
        
        .card { background: rgba(255,255,255,0.05); padding: 25px; margin: 15px auto; max-width: 600px; border-radius: 16px; border:1px solid rgba(255,255,255,0.1); }
        input { padding: 12px; width: 90%; margin: 5px; background: rgba(0,0,0,0.3); border:1px solid #444; color:white; border-radius:8px; }
        
        /* Style untuk History */
        .tx-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; }
        .tx-in { color: #2ed573; }   /* Hijau untuk masuk */
        .tx-out { color: #ff4757; }  /* Merah untuk keluar */
        .tx-mine { color: #eccc68; } /* Kuning untuk mining */
    </style>
</head>
<body>

    <h1>üêë SheepCoin Cloud</h1>
    
    <div id="loginArea">
        <p>Hubungkan dompet untuk memulai.</p>
        <button class="btn-connect" onclick="connectWallet()">ü¶ä Connect MetaMask</button>
    </div>

    <div id="dashboard" style="display:none;">
        <p>Wallet: <span id="myAddress" style="color:#00d4ff; font-family:monospace;">...</span></p>
        <h2 style="font-size:2.5rem; margin:10px 0;">Saldo: <span id="balance">0.0000</span> SHP</h2>
        
        <div class="card">
            <h3>‚õèÔ∏è Local Browser Mining</h3>
            <p style="font-size:0.9rem; color:#ccc;">Gunakan device Anda untuk mencari blok baru.</p>
            <div id="statusLog" style="color: #eccc68; margin-bottom: 10px; font-size:0.9rem; height:20px;">Idle</div>
            <button class="btn-mine" id="btnMine" onclick="startMining()">Start Mining (PoW)</button>
        </div>

        <div class="card">
            <h3>üí∏ Kirim Koin</h3>
            <input id="recipient" placeholder="Address Penerima (0x...)">
            <input id="amount" placeholder="Jumlah (SHP)" type="number">
            <button class="btn-send" id="btnSend" onclick="sendCoin()">üöÄ Kirim (Sign with MetaMask)</button>
        </div>

        <div class="card">
            <h3>üìú Riwayat Transaksi Saya</h3>
            <div id="myHistory" style="text-align:left;">
                <p style="text-align:center; color:#666;">Memuat data...</p>
            </div>
        </div>

        <div class="card">
            <h3>üîó Global Blockchain (Live)</h3>
            <div id="chainList" style="text-align:left; font-size:0.8rem;"></div>
        </div>
    </div>

<script>
    let userAddress = null;

    async function connectWallet() {
        if (window.ethereum) {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                document.getElementById('loginArea').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('myAddress').innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
                updateData();
            } catch (err) { alert("User menolak koneksi"); }
        } else { alert("Install MetaMask!"); }
    }

    async function updateData() {
        if(!userAddress) return;
        
        // 1. Ambil Saldo
        try {
            let res = await fetch('/wallet_info', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress })
            });
            let data = await res.json();
            document.getElementById('balance').innerText = data.balance.toFixed(4);
        } catch(e) {}

        // 2. Ambil Global Chain
        try {
            let chainRes = await fetch('/chain');
            let chainData = await chainRes.json();
            let html = '';
            chainData.chain.forEach(b => {
                html += `<div style="border-bottom:1px solid #333; padding:5px; color:#aaa;">
                    Block #${b.index} | Miner: ${b.miner.substring(0,6)}... | Proof: ${b.proof}
                </div>`;
            });
            document.getElementById('chainList').innerHTML = html;
        } catch(e) {}

        // 3. Ambil Riwayat Transaksi Saya (BARU)
        try {
            let histRes = await fetch('/my_transactions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress })
            });
            let histData = await histRes.json();
            let histHtml = '';
            
            if(histData.transactions.length === 0) {
                histHtml = '<p style="text-align:center; color:#666;">Belum ada transaksi.</p>';
            } else {
                histData.transactions.forEach(tx => {
                    let icon, colorClass, label;
                    
                    if(tx.type === 'MINING') {
                        icon = 'üéÅ'; colorClass = 'tx-mine'; label = 'Mining Reward';
                    } else if (tx.type === 'IN') {
                        icon = '‚¨áÔ∏è'; colorClass = 'tx-in'; label = 'Terima dari ' + tx.sender.substring(0,6);
                    } else {
                        icon = '‚¨ÜÔ∏è'; colorClass = 'tx-out'; label = 'Kirim ke ' + tx.recipient.substring(0,6);
                    }

                    histHtml += `
                        <div class="tx-item">
                            <span>${icon} ${label}</span>
                            <span class="${colorClass}">${tx.type === 'OUT' ? '-' : '+'}${parseFloat(tx.amount).toFixed(2)} SHP</span>
                        </div>
                    `;
                });
            }
            document.getElementById('myHistory').innerHTML = histHtml;
        } catch(e) {}
    }

    // --- LOGIKA MINING ---
    async function startMining() {
        const btn = document.getElementById('btnMine');
        const log = document.getElementById('statusLog');
        btn.disabled = true;
        log.innerText = "Mengambil data blok...";

        try {
            const jobRes = await fetch('/get_mining_job');
            const job = await jobRes.json();
            const lastProof = job.last_proof;
            const target = "0".repeat(job.difficulty);
            
            log.innerText = "Mencari Hash...";
            let proof = 0;
            let found = false;
            
            const miningLoop = async () => {
                for(let i=0; i<5000; i++) {
                    const guess = `${lastProof}${proof}`;
                    const hash = sha256(guess); 
                    if(hash.startsWith(target)) {
                        found = true;
                        submitProof(proof);
                        return;
                    }
                    proof++;
                }
                if(!found) {
                    log.innerText = `Mining... Proof: ${proof}`;
                    setTimeout(miningLoop, 0); 
                }
            };
            miningLoop();
        } catch(e) { 
            log.innerText = "Error koneksi"; 
            btn.disabled = false; 
        }
    }

    async function submitProof(proof) {
        const log = document.getElementById('statusLog');
        log.innerText = `Hash ditemukan! Mengirim ke server...`;
        try {
            const res = await fetch('/submit_block', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ proof: proof, miner: userAddress })
            });
            const data = await res.json();
            if(data.success) {
                log.innerText = `‚úÖ SUKSES! Reward +${data.reward} SHP`;
                updateData();
            } else {
                log.innerText = `‚ùå Ditolak Server`;
            }
        } catch(e) {}
        document.getElementById('btnMine').disabled = false;
    }

    // --- LOGIKA TRANSFER DENGAN METAMASK SIGNING (BARU) ---
    async function sendCoin() {
        const recipient = document.getElementById('recipient').value;
        const amount = document.getElementById('amount').value;
        const btn = document.getElementById('btnSend');

        if(!recipient || !amount) { alert("Isi data lengkap!"); return; }

        try {
            // 1. Trigger MetaMask Sign
            btn.innerText = "ü¶ä Menunggu Konfirmasi...";
            btn.disabled = true;

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            
            // Pesan yang muncul di MetaMask
            const message = `Konfirmasi Transfer SheepCoin:\n\nJumlah: ${amount} SHP\nKe: ${recipient}\n\n(Ini tidak memakan gas fee ETH)`;
            
            // Pop-up MetaMask muncul di sini
            await signer.signMessage(message);

            // 2. Jika User klik "Sign", kirim ke backend
            btn.innerText = "Mengirim...";
            const res = await fetch('/transact', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sender: userAddress, recipient: recipient, amount: amount })
            });
            
            alert("Transaksi Berhasil!");
            document.getElementById('recipient').value = '';
            document.getElementById('amount').value = '';
            updateData();

        } catch (err) {
            console.error(err);
            alert("Transaksi Dibatalkan oleh User");
        }
        
        btn.innerText = "üöÄ Kirim (Sign with MetaMask)";
        btn.disabled = false;
    }
    
    // Auto refresh data setiap 5 detik
    setInterval(updateData, 5000);
</script>
</body>
</html>