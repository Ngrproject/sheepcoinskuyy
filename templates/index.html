<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheepCoin Cloud Mining</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <style>
        body { background: #0f172a; color: white; font-family: 'Space Grotesk'; padding: 20px; text-align: center; margin: 0; }
        button { padding: 12px 20px; font-weight: bold; cursor: pointer; border:none; border-radius:8px; transition:0.3s; font-size: 0.9rem; }
        button:hover { transform: translateY(-2px); opacity:0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-connect { background: #f6851b; color: white; padding: 15px 30px; font-size: 1.1rem; }
        .btn-mine { background: #8A2BE2; color: white; width:100%; margin-top:10px; }
        .btn-stop { background: #ff4757; color: white; width:100%; margin-top:10px; display:none; }
        .btn-send { background: #00d4ff; color: #000; width:100%; margin-top:10px; }
        
        /* Tombol Paket Sewa */
        .grid-packages { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .pkg-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px; font-size: 0.8rem; }
        .pkg-btn:hover { background: var(--primary); border-color: white; }

        .card { background: rgba(255,255,255,0.05); padding: 25px; margin: 15px auto; max-width: 600px; border-radius: 16px; border:1px solid rgba(255,255,255,0.1); }
        input { padding: 12px; width: 90%; margin: 5px 0; background: rgba(0,0,0,0.3); border:1px solid #444; color:white; border-radius:8px; box-sizing: border-box; }
        
        .tx-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; align-items: center; }
        .tx-in { color: #2ed573; } .tx-out { color: #ff4757; } .tx-mine { color: #eccc68; }
        
        #timerDisplay { font-size: 1.2rem; font-weight: bold; color: #2ed573; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>üêë SheepCoin Cloud</h1>
    
    <div id="loginArea">
        <p>Hubungkan MetaMask untuk Mining & Transaksi</p>
        <button class="btn-connect" onclick="connectWallet()">ü¶ä Connect MetaMask</button>
    </div>

    <div id="dashboard" style="display:none;">
        <p>Dompet: <span id="myAddress" style="color:#00d4ff; font-family:monospace;">...</span></p>
        <h2 style="font-size:2.5rem; margin:10px 0;">Saldo: <span id="balance">0.0000</span> SHP</h2>
        
        <div class="card">
            <h3>ü§ñ Auto Mining Rental</h3>
            <p style="font-size:0.8rem; color:#aaa;">Sewa bot untuk mining otomatis tanpa klik.</p>
            
            <div id="rentalPanel">
                <div class="grid-packages">
                    <button class="pkg-btn" onclick="buyPackage(10)">10 Menit<br>(0.5 SHP)</button>
                    <button class="pkg-btn" onclick="buyPackage(30)">30 Menit<br>(1 SHP)</button>
                    <button class="pkg-btn" onclick="buyPackage(60)">1 Jam<br>(2 SHP)</button>
                </div>
            </div>

            <div id="activeRentalPanel" style="display:none; margin-top:15px; padding:10px; background:rgba(46, 213, 115, 0.1); border-radius:8px;">
                <span>‚ö° Auto Mining Sedang Aktif!</span>
                <div id="timerDisplay">00:00:00</div>
                <p style="font-size:0.8rem;">(Jangan tutup tab browser ini)</p>
            </div>
            
            <div id="statusLog" style="color: #eccc68; margin-top: 10px; font-size:0.9rem; height:20px;">Idle</div>
            
            <button class="btn-mine" id="btnMine" onclick="startMining(false)">‚õèÔ∏è Manual Mining (Sekali)</button>
            <button class="btn-stop" id="btnStop" onclick="stopAutoMine()">üõë STOP Auto Mining</button>
        </div>

        <div class="card">
            <h3>üí∏ Kirim Koin</h3>
            <input id="recipient" placeholder="Address Penerima (0x...)">
            <input id="amount" placeholder="Jumlah (SHP)" type="number">
            <button class="btn-send" id="btnSend" onclick="sendCoin()">üöÄ Kirim (Sign)</button>
        </div>

        <div class="card">
            <h3>üìú Riwayat (Terkini)</h3>
            <div id="myHistory"></div>
        </div>
    </div>

<script>
    let userAddress = null;
    let autoMineExpiry = 0; // Timestamp kapan sewa habis
    let isAutoLoopRunning = false;
    let timerInterval = null;

    async function connectWallet() {
        if (window.ethereum) {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                document.getElementById('loginArea').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('myAddress').innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
                updateData();
            } catch (err) {}
        } else { alert("Install MetaMask!"); }
    }

    async function updateData() {
        if(!userAddress) return;
        
        try {
            // Ambil Info Wallet & Status Auto Mine
            let res = await fetch('/wallet_info', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress })
            });
            let data = await res.json();
            document.getElementById('balance').innerText = data.balance.toFixed(4);
            
            // Cek status Auto Mine
            const now = data.server_time;
            autoMineExpiry = data.auto_mine_expires;
            
            const rentalPanel = document.getElementById('rentalPanel');
            const activePanel = document.getElementById('activeRentalPanel');
            const btnStop = document.getElementById('btnStop');
            const timerDisplay = document.getElementById('timerDisplay');

            if (autoMineExpiry > now) {
                // Aktif
                rentalPanel.style.display = 'none';
                activePanel.style.display = 'block';
                btnStop.style.display = 'block';
                
                // Hitung mundur timer
                const timeLeft = Math.floor(autoMineExpiry - now);
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                timerDisplay.innerText = `${m}m ${s}s`;
                
                // Trigger Loop jika belum jalan
                if (!isAutoLoopRunning) {
                    isAutoLoopRunning = true;
                    autoMineLoop();
                }
            } else {
                // Tidak Aktif
                rentalPanel.style.display = 'block';
                activePanel.style.display = 'none';
                btnStop.style.display = 'none';
                isAutoLoopRunning = false;
            }

        } catch(e) {}
        
        // Load History (Kode sama seperti sebelumnya, dipersingkat)
        loadHistory();
    }
    
    async function loadHistory() {
         try {
            let histRes = await fetch('/my_transactions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress })
            });
            let histData = await histRes.json();
            let histHtml = '';
            histData.transactions.forEach(tx => {
                let color = tx.type === 'MINING' ? 'tx-mine' : (tx.type === 'IN' ? 'tx-in' : 'tx-out');
                let sign = tx.type === 'OUT' ? '-' : '+';
                let icon = tx.type === 'MINING' ? 'üéÅ' : (tx.type === 'IN' ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è');
                
                histHtml += `<div class="tx-item">
                    <span>${icon} ${tx.type}</span>
                    <span class="${color}">${sign}${parseFloat(tx.amount).toFixed(4)}</span>
                </div>`;
            });
            document.getElementById('myHistory').innerHTML = histHtml;
        } catch(e) {}
    }

    // --- LOGIKA SEWA ---
    async function buyPackage(minutes) {
        if(!confirm(`Sewa Auto Mining ${minutes} menit?`)) return;
        
        try {
            const res = await fetch('/buy_auto_mine', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress, minutes: minutes })
            });
            const data = await res.json();
            if(data.success) {
                alert(data.message);
                updateData();
            } else {
                alert("Gagal: " + data.message);
            }
        } catch(e) { alert("Error Server"); }
    }

    function stopAutoMine() {
        if(confirm("Yakin hentikan Auto Mining? Waktu sewa akan tetap berjalan habis.")) {
            isAutoLoopRunning = false;
            document.getElementById('statusLog').innerText = "üõë Auto Mining Dihentikan Manual";
            document.getElementById('btnStop').style.display = 'none';
        }
    }

    // --- AUTO MINING LOOP ---
    async function autoMineLoop() {
        const log = document.getElementById('statusLog');
        
        while(isAutoLoopRunning) {
            log.innerText = "ü§ñ Auto Mining: Sedang mencari block...";
            await startMining(true); // true = mode otomatis (silent)
            
            // Jeda 2 detik sebelum mining lagi supaya tidak spamming parah
            await new Promise(r => setTimeout(r, 2000));
            
            // Cek lagi apakah expired
            if(Date.now()/1000 > autoMineExpiry) {
                isAutoLoopRunning = false;
                log.innerText = "‚ö†Ô∏è Waktu Sewa Habis!";
                updateData();
            }
        }
    }

    // --- CORE MINING FUNCTION ---
    async function startMining(isAuto) {
        const btn = document.getElementById('btnMine');
        const log = document.getElementById('statusLog');
        if(!isAuto) btn.disabled = true;

        try {
            const jobRes = await fetch('/get_mining_job');
            const job = await jobRes.json();
            const target = "0".repeat(job.difficulty);
            
            let proof = 0;
            let found = false;
            const lastProof = job.last_proof;

            // Kita pakai Promise agar loop tidak memblokir UI (render)
            await new Promise(resolve => {
                const miningStep = () => {
                    // Coba 2000 hash per frame
                    for(let i=0; i<2000; i++) {
                        const guess = `${lastProof}${proof}`;
                        const hash = sha256(guess); 
                        if(hash.startsWith(target)) {
                            found = true;
                            break;
                        }
                        proof++;
                    }
                    
                    if(found) resolve(); 
                    else if(!isAutoLoopRunning && isAuto) resolve(); // Stop jika tombol stop ditekan
                    else setTimeout(miningStep, 0);
                };
                miningStep();
            });

            if(found) {
                const res = await fetch('/submit_block', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ proof: proof, miner: userAddress })
                });
                const data = await res.json();
                
                if(data.success) {
                    const msg = `‚úÖ Block #${data.index} Found! Reward: ${data.reward} SHP`;
                    log.innerText = msg;
                    if(!isAuto) alert(msg);
                }
            }

        } catch(e) { console.error(e); }
        
        if(!isAuto) btn.disabled = false;
        if(!isAuto) updateData();
    }

    // --- KIRIM KOIN ---
    async function sendCoin() {
        const recipient = document.getElementById('recipient').value;
        const amount = document.getElementById('amount').value;
        const btn = document.getElementById('btnSend');
        
        try {
            btn.innerText = "Sign MetaMask...";
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            await signer.signMessage(`Kirim ${amount} SHP ke ${recipient}`);
            
            btn.innerText = "Mengirim...";
            await fetch('/transact', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sender: userAddress, recipient: recipient, amount: amount })
            });
            alert("Berhasil!");
            updateData();
        } catch(e) { alert("Batal"); }
        btn.innerText = "üöÄ Kirim (Sign)";
    }
    
    setInterval(updateData, 5000);
</script>
</body>
</html>