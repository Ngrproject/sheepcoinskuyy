<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheepCoin Cloud Mining</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <style>
        /* --- MODERN GLASSMORPHISM THEME --- */
        :root {
            --primary-color: #8A2BE2;
            --secondary-color: #00d4ff;
            --accent-color: #f6851b;
            --success-color: #2ed573;
            --danger-color: #ff4757;
            --bg-dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            /* Latar belakang gradien dinamis untuk menonjolkan efek kaca */
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Judul dengan efek gradien */
        h1.main-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(138, 43, 226, 0.3);
        }

        /* Container utama agar rapi */
        .container {
            width: 100%;
            max-width: 600px;
            margin: auto;
        }

        /* --- GLASS CARDS --- */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px); /* Kunci efek kaca */
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: var(--glass-shadow);
            transition: transform 0.3s ease;
        }
        
        /* Sedikit efek hover pada card */
        .card:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        h2, h3 { margin-top: 0; font-weight: 700; }
        p { color: #ccc; line-height: 1.6; }

        /* --- MODERN INPUTS --- */
        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.2); /* Input lebih gelap dan 'tenggelam' */
            border: none;
            border-radius: 12px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); /* Shadow dalam */
            transition: 0.3s;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4), 0 0 0 2px var(--secondary-color);
        }

        /* --- MODERN BUTTONS --- */
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        button:active { transform: translateY(-1px); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-connect {
            background: linear-gradient(45deg, var(--accent-color), #e2761b);
            color: white;
            font-size: 1.2rem;
            padding: 20px;
        }
        .btn-mine { background: linear-gradient(45deg, var(--primary-color), #6a0dad); color: white; margin-top: 15px; }
        .btn-send { background: linear-gradient(45deg, var(--secondary-color), #00a8cc); color: #0f172a; margin-top: 15px; }
        .btn-stop { background: linear-gradient(45deg, var(--danger-color), #c0392b); color: white; margin-top: 15px; }

        /* --- PACKAGE GRID --- */
        .grid-packages {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .pkg-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: var(--secondary-color);
            padding: 15px 10px;
            font-size: 0.9rem;
            border-radius: 16px;
            backdrop-filter: blur(5px);
        }
        .pkg-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* --- ACTIVE PANEL --- */
        #activeRentalPanel {
            background: rgba(46, 213, 115, 0.15) !important;
            border: 1px solid var(--success-color) !important;
            backdrop-filter: blur(10px);
        }

        /* --- LIST ITEMS (History & Chain) --- */
        .tx-item, .block-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            transition: 0.3s;
        }
        .tx-item:hover, .block-item:hover {
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(255,255,255,0.1);
        }

        /* Block Chain Specific */
        .block-item {
            display: block; /* Stack content */
            border-left: 4px solid var(--secondary-color);
            text-align: left;
        }
        .block-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .hash-text {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #aaa;
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 6px;
            word-break: break-all;
        }

        /* Colors */
        .tx-in { color: var(--success-color); font-weight: bold; }
        .tx-out { color: var(--danger-color); font-weight: bold; }
        .tx-mine { color: #ffd700; font-weight: bold; }
        #timerDisplay { font-size: 1.5rem; font-weight: 800; color: var(--success-color); margin: 15px 0; text-shadow: 0 0 10px rgba(46, 213, 115, 0.4); }
        #balance { font-weight: 800; background: linear-gradient(to right, #fff, var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Layout Helper */
        #loginArea {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }
        .balance-container { text-align: center; margin-bottom: 30px; }
    </style>
</head>
<body>

    <h1 class="main-title">üêë SheepCoin Cloud</h1>
    
    <div class="container">
        <div id="loginArea">
            <div class="card" style="text-align: center;">
                <h2>Selamat Datang</h2>
                <p>Hubungkan MetaMask Anda untuk mengakses Dashboard Mining & Transaksi Web3.</p>
                <button class="btn-connect" onclick="connectWallet()">ü¶ä Connect MetaMask</button>
            </div>
        </div>

        <div id="dashboard" style="display:none;">
            <div class="balance-container">
                <p style="margin-bottom: 5px; color:#aaa;">Dompet Terhubung:</p>
                <div id="myAddress" style="color:var(--secondary-color); font-family:monospace; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 20px; display: inline-block; margin-bottom: 20px;">...</div>
                <h2 style="font-size:3rem; margin:0;">Isi Dompet:</h2>
                <h2 style="font-size:3.5rem; margin:0;"><span id="balance">0.0000</span> SHP</h2>
            </div>
            
            <div class="card">
                <h3>ü§ñ Auto Mining Rental</h3>
                <p>Sewa bot cloud untuk melakukan mining otomatis tanpa perlu klik manual.</p>
                
                <div id="rentalPanel">
                    <div class="grid-packages">
                        <button class="pkg-btn" onclick="buyPackage(10)"><strong>10 Menit</strong><br>(0.5 SHP)</button>
                        <button class="pkg-btn" onclick="buyPackage(30)"><strong>30 Menit</strong><br>(1 SHP)</button>
                        <button class="pkg-btn" onclick="buyPackage(60)"><strong>1 Jam</strong><br>(2 SHP)</button>
                    </div>
                </div>

                <div id="activeRentalPanel" class="card" style="display:none;">
                    <span style="font-weight: 700; font-size: 1.1rem;">‚ö° Auto Mining Sedang Aktif!</span>
                    <div id="timerDisplay">00:00:00</div>
                    <p style="font-size:0.9rem; margin:0;">(Bot sedang bekerja, jangan tutup tab ini)</p>
                </div>
                
                <div id="statusLog" style="color: #ffd700; margin-top: 20px; font-weight: 500; min-height:25px; text-align: center;">Idle</div>
                
                <button class="btn-mine" id="btnMine" onclick="startMining(false)">‚õèÔ∏è Manual Mining (Sekali)</button>
                <button class="btn-stop" id="btnStop" onclick="stopAutoMine()" style="display: none;">üõë STOP Auto Mining</button>
            </div>

            <div class="card">
                <h3>üí∏ Kirim Koin</h3>
                <p>Transfer SHP ke pengguna lain secara instan.</p>
                <input id="recipient" placeholder="Alamat Penerima (Contoh: 0xAbC...)" autocomplete="off">
                <input id="amount" placeholder="Jumlah SHP (Contoh: 1.5)" type="number" step="0.0001">
                <button class="btn-send" id="btnSend" onclick="sendCoin()">üöÄ Kirim (Sign MetaMask)</button>
            </div>

            <div class="card">
                <h3>üìú Riwayat Dompet Anda</h3>
                <div id="myHistory" style="max-height: 300px; overflow-y: auto; margin-top: 20px;">
                    <p style="text-align:center;">Memuat data...</p>
                </div>
            </div>

            <div class="card">
                <h3>üîó Global Blockchain Ledger</h3>
                <p style="margin-bottom: 20px;">Aktivitas 10 blok terakhir di jaringan SheepCoin.</p>
                <div id="chainList"></div>
            </div>
        </div>
    </div>

<script>
    let userAddress = null;
    let autoMineExpiry = 0;
    let isAutoLoopRunning = false;

    async function connectWallet() {
        if (window.ethereum) {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                document.getElementById('loginArea').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('myAddress').innerText = userAddress.substring(0,8) + "..." + userAddress.substring(36);
                updateData();
            } catch (err) {}
        } else { alert("Install MetaMask!"); }
    }

    async function updateData() {
        if(!userAddress) return;
        
        try {
            // 1. Info Wallet & Auto Mine
            let res = await fetch('/wallet_info', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress })
            });
            let data = await res.json();
            document.getElementById('balance').innerText = data.balance.toFixed(4);
            
            // Logic Auto Mine Timer
            const now = data.server_time;
            autoMineExpiry = data.auto_mine_expires;
            const rentalPanel = document.getElementById('rentalPanel');
            const activePanel = document.getElementById('activeRentalPanel');
            const btnStop = document.getElementById('btnStop');
            const timerDisplay = document.getElementById('timerDisplay');

            if (autoMineExpiry > now) {
                rentalPanel.style.display = 'none';
                activePanel.style.display = 'block';
                btnStop.style.display = 'block';
                const timeLeft = Math.floor(autoMineExpiry - now);
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                timerDisplay.innerText = `${m}m ${s}s`;
                if (!isAutoLoopRunning) { isAutoLoopRunning = true; autoMineLoop(); }
            } else {
                rentalPanel.style.display = 'block';
                activePanel.style.display = 'none';
                btnStop.style.display = 'none';
                isAutoLoopRunning = false;
            }

        } catch(e) {}
        
        loadHistory();
        loadChain(); // Load Global Chain
    }
    
    async function loadHistory() {
         try {
            let histRes = await fetch('/my_transactions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress })
            });
            let histData = await histRes.json();
            let histHtml = '';
            if(histData.transactions.length === 0){
                histHtml = '<p style="text-align:center; opacity:0.7;">Belum ada transaksi.</p>';
            } else {
                histData.transactions.forEach(tx => {
                    let color = tx.type === 'MINING' ? 'tx-mine' : (tx.type === 'IN' ? 'tx-in' : 'tx-out');
                    let sign = tx.type === 'OUT' ? '-' : '+';
                    let icon = tx.type === 'MINING' ? 'üéÅ' : (tx.type === 'IN' ? '‚¨áÔ∏è From:' : '‚¨ÜÔ∏è To:');
                    let addr = tx.type === 'IN' ? tx.sender : tx.recipient;
                    if(tx.type !== 'MINING') addr = addr.substring(0,6)+'...'; else addr = 'Reward';

                    histHtml += `<div class="tx-item">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:1.2rem">${icon}</span>
                            <div>
                                <div style="font-weight:bold;">${tx.type}</div>
                                <div style="font-size:0.75rem; opacity:0.8;">${addr} (Block #${tx.block})</div>
                            </div>
                        </div>
                        <span class="${color}" style="font-size:1.1rem;">${sign}${parseFloat(tx.amount).toFixed(4)}</span>
                    </div>`;
                });
            }
            document.getElementById('myHistory').innerHTML = histHtml;
        } catch(e) {}
    }

    async function loadChain() {
        try {
            let chainRes = await fetch('/chain');
            let chainData = await chainRes.json();
            let html = '';
            
            chainData.chain.forEach(b => {
                html += `
                <div class="block-item">
                    <div class="block-header">
                        <strong style="color:var(--secondary-color);">Block #${b.index}</strong>
                        <span style="font-size:0.75rem; opacity:0.7;">${b.timestamp}</span>
                    </div>
                    <div class="hash-text">${b.hash}</div>
                    <div style="font-size:0.8rem; margin-top:8px; display:flex; justify-content:space-between;">
                        <span>Miner: <span style="color:var(--accent-color);">${b.miner.substring(0,8)}...</span></span>
                        <span>Proof: <strong>${b.proof}</strong></span>
                    </div>
                </div>
                `;
            });
            document.getElementById('chainList').innerHTML = html;
        } catch(e) {}
    }

    async function buyPackage(minutes) {
        if(!confirm(`Konfirmasi: Sewa Auto Mining selama ${minutes} menit?`)) return;
        try {
            const res = await fetch('/buy_auto_mine', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: userAddress, minutes: minutes })
            });
            const data = await res.json();
            if(data.success) { alert(data.message); updateData(); } 
            else { alert("Gagal: " + data.message); }
        } catch(e) { alert("Error Server"); }
    }

    function stopAutoMine() {
        if(confirm("Yakin hentikan Auto Mining? Waktu sewa akan tetap berjalan.")) {
            isAutoLoopRunning = false;
            document.getElementById('statusLog').innerText = "üõë Dihentikan Manual oleh User";
            document.getElementById('btnStop').style.display = 'none';
        }
    }

    async function autoMineLoop() {
        while(isAutoLoopRunning) {
            document.getElementById('statusLog').innerHTML = "ü§ñ Auto Bot: <span style='color:white;'>Sedang mencari hash...</span>";
            await startMining(true);
            await new Promise(r => setTimeout(r, 2000));
            if(Date.now()/1000 > autoMineExpiry) { isAutoLoopRunning = false; updateData(); }
        }
    }

    async function startMining(isAuto) {
        const btn = document.getElementById('btnMine');
        const log = document.getElementById('statusLog');
        if(!isAuto) btn.disabled = true;
        if(!isAuto) log.innerText = "Menghubungkan ke server...";

        try {
            const jobRes = await fetch('/get_mining_job');
            const job = await jobRes.json();
            const target = "0".repeat(job.difficulty);
            
            let proof = 0;
            let found = false;
            const lastProof = job.last_proof;

            if(!isAuto) log.innerText = "Mulai melakukan hashing (PoW)...";

            await new Promise(resolve => {
                const miningStep = () => {
                    for(let i=0; i<3000; i++) { // Sedikit optimasi loop
                        const guess = `${lastProof}${proof}`;
                        const hash = sha256(guess); 
                        if(hash.startsWith(target)) { found = true; break; }
                        proof++;
                    }
                    if(found) resolve(); 
                    else if(!isAutoLoopRunning && isAuto) resolve();
                    else if(proof > 10000000) { // Safety break jika terlalu lama
                        log.innerText = "Timeout. Mencoba ulang..."; resolve(); 
                    }
                    else setTimeout(miningStep, 0);
                };
                miningStep();
            });

            if(found) {
                if(!isAuto) log.innerText = "Hash ditemukan! Mengirim hasil...";
                const res = await fetch('/submit_block', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ proof: proof, miner: userAddress })
                });
                const data = await res.json();
                if(data.success) {
                    const msg = `‚úÖ Block #${data.index} Ditemukan! Reward: ${data.reward} SHP`;
                    log.innerText = msg;
                    if(!isAuto) alert(msg);
                }
            }
        } catch(e) { console.error(e); if(!isAuto) log.innerText = "Error koneksi server"; }
        
        if(!isAuto) { btn.disabled = false; updateData(); }
    }

    async function sendCoin() {
        const recipient = document.getElementById('recipient').value;
        const amount = document.getElementById('amount').value;
        const btn = document.getElementById('btnSend');
        if(!recipient || !amount) { alert("Mohon isi alamat penerima dan jumlah koin."); return; }

        try {
            btn.innerText = "Menunggu Tanda Tangan MetaMask...";
            btn.disabled = true;
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            await signer.signMessage(`Konfirmasi: Kirim ${amount} SHP ke ${recipient}`);
            
            btn.innerText = "Mengirim Transaksi...";
            const res = await fetch('/transact', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sender: userAddress, recipient: recipient, amount: amount })
            });
            alert("Transaksi Berhasil Dikirim!");
            document.getElementById('recipient').value = '';
            document.getElementById('amount').value = '';
            updateData();
        } catch(e) { alert("Transaksi Dibatalkan."); }
        btn.innerText = "üöÄ Kirim (Sign MetaMask)";
        btn.disabled = false;
    }
    
    setInterval(updateData, 5000);
</script>
</body>
</html>